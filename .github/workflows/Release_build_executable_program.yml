name: 自动构建并发布可执行文件

on:
  push:
    tags:
      - "*.*"
  workflow_dispatch:
    inputs:
      tag:
        type: string
        required: true
        description: "Release tag (e.g. 5.8.0)"

permissions:
  contents: write

env:
  APP_NAME: 禾风起工具箱
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  RELEASE_TAG: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref_name }}

jobs:
  build:
    name: 发布 (Windows)
    runs-on: windows-latest

    steps:
      - name: 签出存储库
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && github.event.inputs.tag || github.ref }}
          submodules: false
          fetch-depth: 0

      - name: 设置 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm
          cache-dependency-path: webui/package-lock.json

      - name: 构建 WebUI
        working-directory: webui
        run: |
          npm ci
          npm run build

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: 安装依赖项
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller

      - name: 构建 Win 可执行文件
        shell: pwsh
        run: |
          pyinstaller --noconsole --name "$env:APP_NAME" --icon=./static/images/DouK-Downloader.ico --add-data "static;static" --add-data "locale;locale" --collect-all emoji main.py

      - name: 写入版本文件
        shell: pwsh
        run: |
          $dir = ("dist\\{0}" -f $env:APP_NAME)
          if (-not (Test-Path $dir)) { throw "dist not found: $dir" }
          Set-Content -LiteralPath (Join-Path $dir "version.txt") -Value $env:RELEASE_TAG -Encoding utf8

      - name: 创建压缩包
        shell: pwsh
        run: |
          $zip = "${env:APP_NAME}_${env:RELEASE_TAG}_${{ runner.os }}.zip"
          if (Test-Path $zip) { Remove-Item $zip -Force }
          Compress-Archive -Path ("dist\\{0}\\*" -f $env:APP_NAME) -DestinationPath $zip
          echo "ZIP_NAME=$zip" >> $env:GITHUB_ENV

      - name: 发布到 GitHub Releases
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.RELEASE_TAG }}
          files: ${{ env.ZIP_NAME }}
          name: ${{ env.APP_NAME }} V${{ env.RELEASE_TAG }}
          generate_release_notes: true
          prerelease: ${{ contains(env.RELEASE_TAG, 'beta') || contains(env.RELEASE_TAG, 'dev') }}
